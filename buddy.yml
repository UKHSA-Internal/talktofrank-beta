- pipeline: "Build"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "*"
  ref_type: "WILDCARD"
  actions:
  - action: "Install dependencies"
    type: "BUILD"
    docker_image_name: "library/node"
    docker_image_tag: "10.13.0"
    execute_commands:
    - "npm install"
    shell: "SH"
  - action: "Validate"
    type: "BUILD"
    docker_image_name: "library/node"
    docker_image_tag: "10.13.0"
    execute_commands:
    - "grunt validate"
    setup_commands:
    - "npm install -g grunt-cli"
    shell: "SH"
  - action: "Build"
    type: "BUILD"
    docker_image_name: "library/node"
    docker_image_tag: "10.13.0"
    execute_commands:
    - "grunt build"
    setup_commands:
    - "npm install -g grunt-cli"
    shell: "SH"
- pipeline: "Preview deployment [PHE]"
  target_site_url: "https://preview.talktofrank.com"
  trigger_mode: "MANUAL"
  ref_name: "master"
  ref_type: "BRANCH"
  always_from_scratch: true
  actions:
  - action: "Install dependencies"
    type: "BUILD"
    working_directory: "/buddy/talktofrank-beta-1"
    docker_image_name: "library/node"
    docker_image_tag: "10.13.0"
    execute_commands:
    - "npm ci"
    mount_filesystem_path: "/buddy/talktofrank-beta-1"
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "Validate"
    type: "BUILD"
    working_directory: "/buddy/talktofrank-beta-1"
    docker_image_name: "library/node"
    docker_image_tag: "10.13.0"
    execute_commands:
    - "grunt validate"
    setup_commands:
    - "npm install -g grunt-cli"
    mount_filesystem_path: "/buddy/talktofrank-beta-1"
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "Build"
    type: "BUILD"
    working_directory: "/buddy/talktofrank-beta-1"
    docker_image_name: "library/node"
    docker_image_tag: "10.13.0"
    execute_commands:
    - "BUILD_CONFIG=preview grunt build"
    setup_commands:
    - "npm install -g grunt-cli"
    mount_filesystem_path: "/buddy/talktofrank-beta-1"
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "Upload redirect file to S3"
    type: "AMAZON_S3"
    input_type: "BUILD_ARTIFACTS"
    local_path: ".ebextensions/redirects.map"
    bucket_name: "elasticbeanstalk-eu-west-2-636728427214"
    integration_hash: "Z7wX90Gz3YaOLgkgbxqlW142Bv"
  - action: "Upload m.talktofrank.com redirect file to S3"
    type: "AMAZON_S3"
    input_type: "BUILD_ARTIFACTS"
    local_path: ".ebextensions/mdot-redirects.map"
    bucket_name: "elasticbeanstalk-eu-west-2-636728427214"
    integration_hash: "Z7wX90Gz3YaOLgkgbxqlW142Bv"
  - action: "Archive directory"
    type: "ZIP"
    local_path: "/"
    destination: "ttf-app.zip"
    deployment_excludes:
    - "app\\*"
    - "contentful\\*"
    - ".git\\*"
    - "*.*"
    - ".*"
    - "node_modules\\*"
    - "grunt\\*"
    - "features\\*"
    - "dist/config.creds.yaml"
    - "dist/config.webhooksecretkey.yaml"
    - "dist/config.mailgun.yaml"
    - "dist/config.ethereal.yaml"
    - "dist/config.google.yaml"
    - "dist/config.sentry.yaml"
    - ".ebextensions\\*"
    deployment_includes:
    - "config.*.yaml"
    - "package.json"
    - ".ebextensions/*.preview_phe.config"
    trigger_condition: "ALWAYS"
  - action: "Upload files to Elastic Beanstalk/talktofrank-uat (preview)"
    type: "ELASTIC_BEANSTALK"
    local_path: "ttf-app.zip"
    application_name: "talktofrank-uat"
    environment: "e-2xnjr22fck"
    environment_name: "talktofrankuat-preview"
    region: "eu-west-2"
    trigger_condition: "ALWAYS"
    integration_hash: "Z7wX90Gz3YaOLgkgbxqlW142Bv"
- pipeline: "UAT deployment [PHE]"
  target_site_url: "https://staging.talktofrank.com"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "develop"
  ref_type: "BRANCH"
  always_from_scratch: true
  actions:
  - action: "Install dependencies"
    type: "BUILD"
    working_directory: "/buddy/talktofrank-beta-1"
    docker_image_name: "library/node"
    docker_image_tag: "10.13.0"
    execute_commands:
    - "npm ci"
    mount_filesystem_path: "/buddy/talktofrank-beta-1"
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "Validate"
    type: "BUILD"
    working_directory: "/buddy/talktofrank-beta-1"
    docker_image_name: "library/node"
    docker_image_tag: "10.13.0"
    execute_commands:
    - "grunt validate"
    setup_commands:
    - "npm install -g grunt-cli"
    mount_filesystem_path: "/buddy/talktofrank-beta-1"
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "Build"
    type: "BUILD"
    working_directory: "/buddy/talktofrank-beta-1"
    docker_image_name: "library/node"
    docker_image_tag: "10.13.0"
    execute_commands:
    - "BUILD_CONFIG=uat grunt build"
    setup_commands:
    - "npm install -g grunt-cli"
    mount_filesystem_path: "/buddy/talktofrank-beta-1"
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "Upload redirect file to S3"
    type: "AMAZON_S3"
    input_type: "BUILD_ARTIFACTS"
    local_path: ".ebextensions/redirects.map"
    bucket_name: "elasticbeanstalk-eu-west-2-636728427214"
    integration_hash: "Z7wX90Gz3YaOLgkgbxqlW142Bv"
  - action: "Upload m.talktofrank.com redirect file to S3"
    type: "AMAZON_S3"
    input_type: "BUILD_ARTIFACTS"
    local_path: ".ebextensions/mdot-redirects.map"
    bucket_name: "elasticbeanstalk-eu-west-2-636728427214"
    integration_hash: "Z7wX90Gz3YaOLgkgbxqlW142Bv"
  - action: "Archive directory"
    type: "ZIP"
    local_path: "/"
    destination: "ttf-app.zip"
    deployment_excludes:
    - "app\\*"
    - "contentful\\*"
    - ".git\\*"
    - "*.*"
    - ".*"
    - "node_modules\\*"
    - "grunt\\*"
    - "features\\*"
    - "dist/config.creds.yaml"
    - "dist/config.webhooksecretkey.yaml"
    - "dist/config.mailgun.yaml"
    - "dist/config.ethereal.yaml"
    - "dist/config.google.yaml"
    - "dist/config.sentry.yaml"
    - ".ebextensions\\*"
    deployment_includes:
    - "config.*.yaml"
    - "package.json"
    - ".ebextensions/*.uat_phe.config"
    - ".ebextensions/01_gzip.config"
    trigger_condition: "ALWAYS"
  - action: "Upload files to Elastic Beanstalk/talktofrank-uat"
    type: "ELASTIC_BEANSTALK"
    local_path: "ttf-app.zip"
    application_name: "talktofrank-uat"
    environment: "e-w753enfajj"
    environment_name: "talktofrankuat-env"
    region: "eu-west-2"
    trigger_condition: "ALWAYS"
    integration_hash: "Z7wX90Gz3YaOLgkgbxqlW142Bv"
- pipeline: "Production deployment [PHE]"
  trigger_mode: "MANUAL"
  ref_name: "master"
  ref_type: "BRANCH"
  always_from_scratch: true
  actions:
  - action: "Install dependencies"
    type: "BUILD"
    working_directory: "/buddy/talktofrank-beta-1"
    docker_image_name: "library/node"
    docker_image_tag: "10.13.0"
    execute_commands:
    - "npm ci"
    mount_filesystem_path: "/buddy/talktofrank-beta-1"
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "Validate"
    type: "BUILD"
    working_directory: "/buddy/talktofrank-beta-1"
    docker_image_name: "library/node"
    docker_image_tag: "10.13.0"
    execute_commands:
    - "grunt validate"
    setup_commands:
    - "npm install -g grunt-cli"
    mount_filesystem_path: "/buddy/talktofrank-beta-1"
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "Build"
    type: "BUILD"
    working_directory: "/buddy/talktofrank-beta-1"
    docker_image_name: "library/node"
    docker_image_tag: "10.13.0"
    execute_commands:
    - "BUILD_CONFIG=production grunt build"
    setup_commands:
    - "npm install -g grunt-cli"
    mount_filesystem_path: "/buddy/talktofrank-beta-1"
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "Upload redirect file to S3"
    type: "AMAZON_S3"
    input_type: "BUILD_ARTIFACTS"
    local_path: ".ebextensions/redirects.map"
    bucket_name: "elasticbeanstalk-eu-west-2-116851924324"
    integration_hash: "Z7wX90Gz3YaOLgkgbxqlW142Bv"
  - action: "Upload m.talktofrank.com redirect file to S3"
    type: "AMAZON_S3"
    input_type: "BUILD_ARTIFACTS"
    local_path: ".ebextensions/mdot-redirects.map"
    bucket_name: "elasticbeanstalk-eu-west-2-116851924324"
    integration_hash: "Z7wX90Gz3YaOLgkgbxqlW142Bv"
  - action: "Archive directory"
    type: "ZIP"
    local_path: "/"
    destination: "ttf-app.zip"
    deployment_excludes:
    - "app\\*"
    - "contentful\\*"
    - ".git\\*"
    - "*.*"
    - ".*"
    - "node_modules\\*"
    - "grunt\\*"
    - "features\\*"
    - "dist/config.creds.yaml"
    - "dist/config.webhooksecretkey.yaml"
    - "dist/config.mailgun.yaml"
    - "dist/config.ethereal.yaml"
    - "dist/config.google.yaml"
    - "dist/config.sentry.yaml"
    - ".ebextensions\\*"
    deployment_includes:
    - "config.*.yaml"
    - "package.json"
    - ".ebextensions/*.prod_phe.config"
    trigger_condition: "ALWAYS"
  - action: "Upload files to Elastic Beanstalk/ttf-prod-app"
    type: "ELASTIC_BEANSTALK"
    local_path: "ttf-app.zip"
    application_name: "ttf-prod-app"
    environment: "e-irmhrbnfie"
    environment_name: "ttfprodapp-env"
    region: "eu-west-2"
    trigger_condition: "ALWAYS"
    integration_hash: "Z7wX90Gz3YaOLgkgbxqlW142Bv"
  - action: "Run preview deployment"
    type: "RUN_NEXT_PIPELINE"
    wait: false
    comment: "Triggered by $BUDDY_PIPELINE_NAME execution #$BUDDY_EXECUTION_ID"
    revision: "INHERIT"
    trigger_condition: "ALWAYS"
    next_pipeline_id: 164861
